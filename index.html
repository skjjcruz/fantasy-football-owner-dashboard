<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draft Board v2.0</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    .scroll-container { 
      scrollbar-width: thin;
      scrollbar-color: #475569 #1e293b;
    }
    .scroll-container::-webkit-scrollbar { width: 8px; }
    .scroll-container::-webkit-scrollbar-track { background: #1e293b; }
    .scroll-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const SPORT = "nfl";
    const DEFAULT_LEAGUE_SEASON = "2026";
    const DEFAULT_STATS_SEASON = "2025";
    const LS_LOCKED_USERNAME = "draft_board_v2_username";

    const mockPlayers = [
      { id: 1, name: 'Cameron Ward', pos: 'QB', school: 'Miami', size: '6\'2"', weight: 223, speed: 4.58, tier: 1 },
      { id: 2, name: 'Shedeur Sanders', pos: 'QB', school: 'Colorado', size: '6\'2"', weight: 215, speed: 4.6, tier: 1 },
      { id: 3, name: 'Quinn Ewers', pos: 'QB', school: 'Texas', size: '6\'2"', weight: 195, speed: 4.7, tier: 1 },
      { id: 4, name: 'Riley Leonard', pos: 'QB', school: 'Notre Dame', size: '6\'4"', weight: 212, speed: 4.5, tier: 2 },
      { id: 5, name: 'Ashton Jeanty', pos: 'RB', school: 'Boise State', size: '5\'9"', weight: 215, speed: 4.42, tier: 1 },
      { id: 6, name: 'Omarion Hampton', pos: 'RB', school: 'UNC', size: '6\'0"', weight: 220, speed: 4.5, tier: 1 },
      { id: 7, name: 'Travis Hunter', pos: 'WR', school: 'Colorado', size: '6\'1"', weight: 185, speed: 4.3, tier: 1 },
      { id: 8, name: 'Tetairoa McMillan', pos: 'WR', school: 'Arizona', size: '6\'5"', weight: 210, speed: 4.5, tier: 1 },
      { id: 9, name: 'Emeka Egbuka', pos: 'WR', school: 'Ohio State', size: '6\'1"', weight: 206, speed: 4.3, tier: 1 },
      { id: 10, name: 'Abdul Carter', pos: 'EDGE', school: 'Penn State', size: '6\'3"', weight: 252, speed: 4.4, tier: 1 },
    ];

    const positions = ['QB', 'RB', 'WR', 'TE', 'EDGE', 'DL', 'LB', 'DB', 'K'];

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // Read URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        username: params.get('username') || '',
        season: params.get('season') || DEFAULT_LEAGUE_SEASON
      };
    }

    const DraftBoard = () => {
      const [numTeams] = useState(16);
      const [numRounds] = useState(7);
      const [draftType] = useState('snake');
      const [selectedPos, setSelectedPos] = useState('ALL');
      const [searchTerm, setSearchTerm] = useState('');
      const [players] = useState(mockPlayers);
      const [draftPicks, setDraftPicks] = useState({});
      const [selectedPickSlot, setSelectedPickSlot] = useState(null);
      
      // Get URL params on mount
      const urlParams = getUrlParams();
      
      const [sleeperUsername, setSleeperUsername] = useState(() => {
        return urlParams.username || localStorage.getItem(LS_LOCKED_USERNAME) || 'skjjcruz';
      });
      const [sleeperUserId, setSleeperUserId] = useState(null);
      const [userLeagues, setUserLeagues] = useState([]);
      const [selectedLeague, setSelectedLeague] = useState(null);
      const [leagueSeason, setLeagueSeason] = useState(urlParams.season || DEFAULT_LEAGUE_SEASON);
      const [statsSeason, setStatsSeason] = useState(DEFAULT_STATS_SEASON);
      const [loading, setLoading] = useState(false);
      const [status, setStatus] = useState('Loading from dashboard...');
      
      // Draft history
      const [availableDrafts, setAvailableDrafts] = useState([]);
      const [selectedDraft, setSelectedDraft] = useState(null);
      const [draftYear, setDraftYear] = useState(null);
      const [sleeperPlayers, setSleeperPlayers] = useState(null);
      const [leagueRosters, setLeagueRosters] = useState([]);
      const [leagueUsers, setLeagueUsers] = useState([]);

      // Auto-load on mount if we have URL params
      useEffect(() => {
        if (urlParams.username) {
          fetchSleeperUser(urlParams.username);
        } else if (localStorage.getItem(LS_LOCKED_USERNAME)) {
          fetchSleeperUser(localStorage.getItem(LS_LOCKED_USERNAME));
        } else {
          setStatus('Enter Sleeper username and click Reload');
        }
      }, []);

      const fetchSleeperUser = async (username) => {
        if (!username) {
          setStatus('Enter a Sleeper username.');
          return;
        }
        
        setLoading(true);
        
        try {
          setStatus('Loading Sleeper user‚Ä¶');
          const userData = await fetchJSON(`https://api.sleeper.app/v1/user/${encodeURIComponent(username)}`);
          setSleeperUserId(userData.user_id);
          localStorage.setItem(LS_LOCKED_USERNAME, username);
          
          setStatus('Loading leagues‚Ä¶');
          const leaguesData = await fetchJSON(
            `https://api.sleeper.app/v1/user/${userData.user_id}/leagues/${SPORT}/${leagueSeason}`
          );
          
          if (!leaguesData || leaguesData.length === 0) {
            setStatus('No leagues found for that season.');
            setUserLeagues([]);
            return;
          }
          
          const mappedLeagues = leaguesData.map(league => ({
            id: league.league_id,
            name: league.name,
            type: league.settings?.type || 'redraft',
            totalRosters: league.total_rosters,
            season: league.season,
            status: league.status,
            draftId: league.draft_id
          }));
          
          setUserLeagues(mappedLeagues);
          
          let auto = mappedLeagues[0];
          const psycho = mappedLeagues.find(l => (l.name || '').toLowerCase().includes('psycho'));
          if (psycho) auto = psycho;
          
          setSelectedLeague(auto);
          
          // Load drafts for selected league
          await loadDraftsForLeague(auto.id);
          
          setStatus(`Leagues loaded ‚úÖ - ${mappedLeagues.length} league(s) found`);
          
        } catch (err) {
          setStatus(`Error: ${err.message}`);
          console.error('Sleeper API Error:', err);
        } finally {
          setLoading(false);
        }
      };

      const loadDraftsForLeague = async (leagueId) => {
        if (!leagueId) return;
        
        try {
          setStatus('Loading draft history‚Ä¶');
          
          // Load league rosters and users for owner info
          const [draftsData, rostersData, usersData] = await Promise.all([
            fetchJSON(`https://api.sleeper.app/v1/league/${leagueId}/drafts`),
            fetchJSON(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
            fetchJSON(`https://api.sleeper.app/v1/league/${leagueId}/users`)
          ]);
          
          setLeagueRosters(rostersData || []);
          setLeagueUsers(usersData || []);
          
          if (!draftsData || draftsData.length === 0) {
            setAvailableDrafts([]);
            setSelectedDraft(null);
            setDraftYear(null);
            setStatus('No drafts found for this league.');
            return;
          }
          
          // Sort drafts by most recent first
          const sortedDrafts = draftsData.sort((a, b) => {
            return Number(b.season || 0) - Number(a.season || 0);
          });
          
          setAvailableDrafts(sortedDrafts);
          
          // Auto-select most recent draft
          const mostRecent = sortedDrafts[0];
          setSelectedDraft(mostRecent);
          setDraftYear(mostRecent.season);
          
          // Load picks for this draft
          await loadDraftPicks(mostRecent.draft_id);
          
        } catch (err) {
          console.error('Error loading drafts:', err);
          setStatus('Failed to load draft history.');
        }
      };

      const loadDraftPicks = async (draftId) => {
        if (!draftId) return;
        
        try {
          setStatus('Loading draft picks‚Ä¶');
          
          // Load Sleeper player database if not already loaded
          if (!sleeperPlayers) {
            setStatus('Loading player database‚Ä¶');
            const playersData = await fetchJSON(`https://api.sleeper.app/v1/players/${SPORT}`);
            setSleeperPlayers(playersData);
          }
          
          const picksData = await fetchJSON(`https://api.sleeper.app/v1/draft/${draftId}/picks`);
          
          if (!picksData || picksData.length === 0) {
            setDraftPicks({});
            setStatus('No picks found for this draft.');
            return;
          }
          
          // Map picks to our format with player data
          const mappedPicks = {};
          picksData.forEach(pick => {
            const key = `${pick.round}.${String(pick.draft_slot).padStart(2, '0')}`;
            mappedPicks[key] = {
              playerId: pick.player_id,
              metadata: pick.metadata,
              pickedBy: pick.picked_by
            };
          });
          
          setDraftPicks(mappedPicks);
          setStatus(`Draft loaded ‚úÖ - ${picksData.length} picks`);
          
        } catch (err) {
          console.error('Error loading picks:', err);
          setStatus('Failed to load draft picks.');
        }
      };

      const handleDraftYearChange = (year) => {
        const draft = availableDrafts.find(d => d.season === year);
        if (draft) {
          setSelectedDraft(draft);
          setDraftYear(year);
          loadDraftPicks(draft.draft_id);
        }
      };

      const handleLeagueChange = (leagueId) => {
        const league = userLeagues.find(l => l.id === leagueId);
        setSelectedLeague(league);
        loadDraftsForLeague(leagueId);
      };

      const handleReload = () => {
        fetchSleeperUser(sleeperUsername);
      };

      const handleBackToDashboard = () => {
        // Close this tab/window if it was opened by the dashboard
        if (window.opener) {
          window.close();
        } else {
          // Otherwise navigate back to the dashboard
          window.location.href = 'index.html';
        }
      };

      const generateDraftOrder = () => {
        const order = [];
        for (let round = 1; round <= numRounds; round++) {
          for (let team = 1; team <= numTeams; team++) {
            const pickNum = draftType === 'snake' && round % 2 === 0 
              ? numTeams - team + 1 
              : team;
            order.push({
              round,
              pick: pickNum,
              overall: (round - 1) * numTeams + team,
              team: pickNum,
              key: `${round}.${String(pickNum).padStart(2, '0')}`
            });
          }
        }
        return order;
      };

      const draftOrder = generateDraftOrder();

      const filteredPlayers = players.filter(p => {
        const matchesPos = selectedPos === 'ALL' || p.pos === selectedPos;
        const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase());
        const notDrafted = !Object.values(draftPicks).includes(p.id);
        return matchesPos && matchesSearch && notDrafted;
      });

      const positionCounts = positions.reduce((acc, pos) => {
        acc[pos] = players.filter(p => p.pos === pos && !Object.values(draftPicks).includes(p.id)).length;
        return acc;
      }, {});
      const totalAvailable = players.filter(p => !Object.values(draftPicks).includes(p.id)).length;

      const handlePlayerClick = (player) => {
        if (!selectedPickSlot) {
          const nextPick = draftOrder.find(pick => !draftPicks[pick.key]);
          if (nextPick) {
            setDraftPicks(prev => ({ ...prev, [nextPick.key]: player.id }));
          }
        } else {
          setDraftPicks(prev => ({ ...prev, [selectedPickSlot]: player.id }));
          setSelectedPickSlot(null);
        }
      };

      const handlePickSlotClick = (pickKey) => {
        if (draftPicks[pickKey]) {
          const newPicks = { ...draftPicks };
          delete newPicks[pickKey];
          setDraftPicks(newPicks);
        } else {
          setSelectedPickSlot(pickKey);
        }
      };

      const picksByRound = draftOrder.reduce((acc, pick) => {
        if (!acc[pick.round]) acc[pick.round] = [];
        acc[pick.round].push(pick);
        return acc;
      }, {});

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100">
          <div className="bg-slate-900 border-b border-slate-700 px-4 py-3">
            <div className="flex flex-wrap gap-4 items-center">
              <input
                type="text"
                placeholder="Sleeper username"
                value={sleeperUsername}
                onChange={(e) => setSleeperUsername(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleReload()}
                className="bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm text-slate-100 w-32"
              />

              <div className="flex items-center gap-2">
                <label className="text-sm text-slate-400">League Season:</label>
                <select 
                  value={leagueSeason}
                  onChange={(e) => setLeagueSeason(e.target.value)}
                  className="bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm text-slate-100"
                >
                  {['2026', '2025', '2024', '2023'].map(year => (
                    <option key={year} value={year}>{year}</option>
                  ))}
                </select>
              </div>

              <div className="flex items-center gap-2">
                <label className="text-sm text-slate-400">Stats Season:</label>
                <select 
                  value={statsSeason}
                  onChange={(e) => setStatsSeason(e.target.value)}
                  className="bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm text-slate-100"
                >
                  {['2025', '2024', '2023', '2022'].map(year => (
                    <option key={year} value={year}>{year}</option>
                  ))}
                </select>
              </div>

              <div className="flex items-center gap-2">
                <label className="text-sm text-slate-400">League:</label>
                <select 
                  value={selectedLeague?.id || ''}
                  onChange={(e) => handleLeagueChange(e.target.value)}
                  className="bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm text-slate-100 min-w-[200px]"
                  disabled={loading || userLeagues.length === 0}
                >
                  {userLeagues.length === 0 ? (
                    <option value="">No leagues</option>
                  ) : (
                    userLeagues.map(league => (
                      <option key={league.id} value={league.id}>{league.name}</option>
                    ))
                  )}
                </select>
              </div>

              <div className="flex items-center gap-2">
                <label className="text-sm text-slate-400">Draft Year:</label>
                <select 
                  value={draftYear || ''}
                  onChange={(e) => handleDraftYearChange(e.target.value)}
                  className="bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm text-slate-100"
                  disabled={loading || availableDrafts.length === 0}
                >
                  {availableDrafts.length === 0 ? (
                    <option value="">No drafts</option>
                  ) : (
                    availableDrafts.map(draft => (
                      <option key={draft.draft_id} value={draft.season}>
                        {draft.season} {draft.status === 'complete' ? '(Complete)' : draft.status === 'in_progress' ? '(In Progress)' : '(Not Started)'}
                      </option>
                    ))
                  )}
                </select>
              </div>

              <button 
                onClick={handleReload}
                disabled={loading || !sleeperUsername}
                className="px-4 py-1.5 bg-yellow-500 hover:bg-yellow-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-slate-900 rounded text-sm font-bold"
              >
                {loading ? 'Loading...' : 'Reload'}
              </button>

              <button 
                onClick={handleBackToDashboard}
                className="ml-auto px-4 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded text-sm font-bold"
              >
                ‚Üê Back to Dashboard
              </button>
            </div>

            <div className="mt-2 text-xs text-slate-500">
              {status}
            </div>
          </div>

          <div className="sticky top-0 z-50 bg-slate-900 border-b border-slate-700 p-4">
            <div className="flex flex-wrap gap-4 items-center justify-between">
              <h1 className="text-xl font-bold text-yellow-500">
                Draft Board v2.0
                {draftYear && selectedDraft && (
                  <span className="ml-3 text-sm text-slate-400 font-normal">
                    üìú Viewing {draftYear} Draft
                    {selectedDraft.status === 'complete' && ' (Complete)'}
                    {selectedDraft.status === 'in_progress' && ' (In Progress)'}
                  </span>
                )}
              </h1>
              <div className="flex gap-4 items-center text-sm text-slate-400">
                <span>16 Teams ‚Ä¢ 7 Rounds ‚Ä¢ Snake Draft</span>
                <button 
                  onClick={() => setDraftPicks({})}
                  className="px-4 py-1.5 bg-red-600 hover:bg-red-700 rounded text-sm font-bold text-white"
                >
                  Clear Draft
                </button>
              </div>
            </div>
          </div>

          <div className="flex gap-4 p-4 h-[calc(100vh-180px)]">
            <div className="w-1/2 bg-slate-900 border border-slate-700 rounded-lg overflow-hidden flex flex-col">
              <div className="bg-slate-800 px-4 py-3 border-b border-slate-700 flex-shrink-0">
                <h2 className="font-bold text-yellow-500">Draft Board</h2>
              </div>
              
              <div className="flex-1 p-4 space-y-6 overflow-y-auto scroll-container">
                {Object.entries(picksByRound).map(([round, picks]) => (
                  <div key={round}>
                    <div className="sticky top-0 bg-slate-900 py-2 mb-3 border-b-2 border-yellow-500 z-10">
                      <h3 className="font-bold text-yellow-500 text-lg">Round {round}</h3>
                    </div>
                    
                    <div className="space-y-2">
                      {picks.map(pick => {
                        const pickData = draftPicks[pick.key];
                        const isSelected = selectedPickSlot === pick.key;
                        
                        let player = null;
                        let displayName = 'Available';
                        let displayDetails = null;
                        let ownerInfo = null;
                        let isMyPick = false;
                        
                        if (pickData) {
                          // Check if it's historical Sleeper data
                          if (typeof pickData === 'object' && pickData.playerId) {
                            const sleeperPlayer = sleeperPlayers?.[pickData.playerId];
                            if (sleeperPlayer) {
                              displayName = sleeperPlayer.full_name || sleeperPlayer.first_name + ' ' + sleeperPlayer.last_name || 'Unknown Player';
                              displayDetails = `${sleeperPlayer.position || ''} ‚Ä¢ ${sleeperPlayer.team || 'FA'}`;
                            } else {
                              displayName = pickData.metadata?.first_name && pickData.metadata?.last_name 
                                ? `${pickData.metadata.first_name} ${pickData.metadata.last_name}`
                                : 'Unknown Player';
                              displayDetails = pickData.metadata?.position || '';
                            }
                            
                            // Get owner info
                            const pickedByUserId = pickData.pickedBy;
                            const owner = leagueUsers.find(u => u.user_id === pickedByUserId);
                            if (owner) {
                              ownerInfo = {
                                name: owner.display_name || owner.username,
                                avatar: owner.avatar
                              };
                              // Check if this is the logged-in user's pick
                              isMyPick = pickedByUserId === sleeperUserId;
                            }
                          } else {
                            // Mock player data (for manual drafting)
                            player = players.find(p => p.id === pickData);
                            if (player) {
                              displayName = player.name;
                              displayDetails = `${player.pos} ‚Ä¢ ${player.school}`;
                            }
                          }
                        }
                        
                        return (
                          <div
                            key={pick.key}
                            onClick={() => handlePickSlotClick(pick.key)}
                            className={`p-3 rounded border cursor-pointer transition-all flex items-center gap-3 ${
                              isSelected ? 'border-yellow-500 bg-yellow-500 bg-opacity-10' : 
                              isMyPick ? 'border-emerald-600 bg-emerald-900 bg-opacity-40' :
                              pickData ? 'border-slate-600 bg-slate-800' : 
                              'border-slate-600 bg-slate-800 hover:border-slate-500'
                            }`}
                          >
                            <div className="w-20 text-center">
                              <div className="font-bold text-yellow-500">{pick.key}</div>
                              <div className="text-xs text-slate-500">#{pick.overall}</div>
                            </div>
                            
                            <div className="flex-1 min-w-0">
                              <div className="font-bold truncate">{displayName}</div>
                              {displayDetails && (
                                <div className="text-sm text-slate-400 flex gap-3 mt-0.5">
                                  {displayDetails}
                                </div>
                              )}
                              {ownerInfo && (
                                <div className="flex items-center gap-2 mt-1">
                                  {ownerInfo.avatar && (
                                    <img 
                                      src={`https://sleepercdn.com/avatars/thumbs/${ownerInfo.avatar}`}
                                      alt=""
                                      className="w-5 h-5 rounded-full"
                                      onError={(e) => e.target.style.display = 'none'}
                                    />
                                  )}
                                  <span className="text-xs text-slate-500">
                                    {isMyPick ? '‚úì ' : ''}{ownerInfo.name}
                                  </span>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="w-1/2 bg-slate-900 border border-slate-700 rounded-lg overflow-hidden flex flex-col">
              <div className="bg-slate-800 px-4 py-3 border-b border-slate-700 flex-shrink-0">
                <h2 className="font-bold text-yellow-500 mb-3">Player Rankings</h2>
                
                <input
                  type="text"
                  placeholder="Search players..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-slate-100 mb-3"
                />

                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={() => setSelectedPos('ALL')}
                    className={`px-3 py-1 rounded text-xs font-bold ${
                      selectedPos === 'ALL' ? 'bg-yellow-500 text-slate-900' : 'bg-slate-700'
                    }`}
                  >
                    ALL ({totalAvailable})
                  </button>
                  {positions.map(pos => (
                    <button
                      key={pos}
                      onClick={() => setSelectedPos(pos)}
                      className={`px-3 py-1 rounded text-xs font-bold ${
                        selectedPos === pos ? 'bg-yellow-500 text-slate-900' : 'bg-slate-700'
                      }`}
                    >
                      {pos} ({positionCounts[pos] || 0})
                    </button>
                  ))}
                </div>
              </div>

              <div className="flex-1 overflow-y-auto scroll-container">
                {filteredPlayers.map((player, idx) => (
                  <div
                    key={player.id}
                    onClick={() => handlePlayerClick(player)}
                    className="p-3 hover:bg-slate-800 cursor-pointer border-b border-slate-700"
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-8 text-slate-500 font-bold">{idx + 1}</div>
                      <div className="flex-1">
                        <div className="font-bold">{player.name}</div>
                        <div className="text-xs text-slate-400">
                          {player.pos} ‚Ä¢ {player.school} ‚Ä¢ {player.size} ‚Ä¢ {player.weight} lbs
                        </div>
                      </div>
                      <div className="text-xs px-2 py-1 rounded bg-slate-700">
                        Tier {player.tier}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<DraftBoard />, document.getElementById('root'));
  </script>

</body>
</html>
